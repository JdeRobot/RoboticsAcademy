<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.5 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Local navigation with VFF - Robotics-Academy</title>
<meta name="description" content="A practical and fun way of learning Robotics and Computer Vision">



<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Robotics-Academy">
<meta property="og:title" content="Local navigation with VFF">
<meta property="og:url" content="http://localhost:4000/exercises/AutonomousCars/obstacle_avoidance">












  

  


<link rel="canonical" href="http://localhost:4000/exercises/AutonomousCars/obstacle_avoidance">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "JdeRobot",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Robotics-Academy Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="icon" type="image/png" href="/assets/images/logo.png" sizes="16x16">
<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Robotics-Academy
          <span class="site-subtitle">by JdeRobot organization</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/exercises/" >Exercises</a>
            </li><li class="masthead__menu-item">
              <a href="/installation/" >Installation</a>
            </li><li class="masthead__menu-item">
              <a href="https://forum.jderobot.org/c/english/roboticsacademy" >Forum</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          
          

          <a href="/exercises/"><span class="nav__sub-title">Exercises</span></a>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/exercises/autonomous_cars_section" class="">Autonomous Driving</a></li>
          
            
            

            
            

            <li><a href="/exercises/mobile_robots_section" class="">Service Robots</a></li>
          
            
            

            
            

            <li><a href="/exercises/drones_section" class="">Drones</a></li>
          
            
            

            
            

            <li><a href="/exercises/computer_vision_section" class="">Computer Vision</a></li>
          
            
            

            
            

            <li><a href="/exercises/industrial_robots_section" class="">Industrial Robots</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Contribute</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/roadmap/" class="">Roadmap</a></li>
          
            
            

            
            

            <li><a href="/contribute/" class="">How to contribute</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Local navigation with VFF">
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Local navigation with VFF
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> TOC Visual Follow Line</h4></header>
              <ul class="toc__menu">
  <li><a href="#versions-to-run-the-exercise">Versions to run the exercise</a></li>
  <li><a href="#objective">Objective</a></li>
  <li><a href="#instructions-for-web-templates">Instructions for Web Templates</a>
    <ul>
      <li><a href="#installation">Installation</a></li>
      <li><a href="#enable-gpu-acceleration">Enable GPU Acceleration</a></li>
      <li><a href="#how-to-perform-the-exercise">How to perform the exercise?</a></li>
      <li><a href="#using-the-interface">Using the Interface</a></li>
    </ul>
  </li>
  <li><a href="#instructions-for-rosnode-templates">Instructions for ROSNode Templates</a>
    <ul>
      <li><a href="#installation-1">Installation</a></li>
      <li><a href="#how-to-run-your-solution">How to run your solution?</a></li>
      <li><a href="#how-to-do-the-practice">How to do the practice</a></li>
      <li><a href="#conversion-of-types">Conversion of types</a></li>
      <li><a href="#debugging">Debugging</a></li>
    </ul>
  </li>
  <li><a href="#theory">Theory</a>
    <ul>
      <li><a href="#navigation">Navigation</a></li>
      <li><a href="#global-navigation">Global Navigation</a></li>
      <li><a href="#local-navigation">Local Navigation</a></li>
      <li><a href="#virtual-force-field-algorithm">Virtual Force Field Algorithm</a></li>
      <li><a href="#drawbacks">Drawbacks</a></li>
      <li><a href="#virtual-force-histogram-algorithm">Virtual Force Histogram Algorithm</a></li>
    </ul>
  </li>
  <li><a href="#hints">Hints</a>
    <ul>
      <li><a href="#determining-the-vectors">Determining the Vectors</a></li>
      <li><a href="#target-vector">Target Vector</a></li>
      <li><a href="#obstacle-vector">Obstacle Vector</a></li>
      <li><a href="#direction-vector">Direction Vector</a></li>
      <li><a href="#illustrations">Illustrations</a></li>
    </ul>
  </li>
  <li><a href="#demonstrative-video">Demonstrative Video</a></li>
  <li><a href="#contributors">Contributors</a></li>
  <li><a href="#references">References</a></li>
</ul>
            </nav>
          </aside>
        
        <h2 id="versions-to-run-the-exercise">Versions to run the exercise</h2>

<p>Currently, there are 2 versions for running this exercise:</p>

<ul>
  <li>ROSNode Templates</li>
  <li>Web Templates(Current Release)</li>
</ul>

<p>The instructions for both of them are provided as follows.</p>

<h2 id="objective">Objective</h2>

<p>The objective of this practice is to implement the logic of the VFF navigation algorithm.</p>

<p>Navigation using VFF (Virtual Force Field), consists of:</p>

<ul>
  <li>
    <p>Each object in the environment generates a repulsive force towards the robot.</p>
  </li>
  <li>
    <p>Destiny generates an attractive force in the robot.</p>
  </li>
</ul>

<p>This makes it possible for the robot to go towards the target, distancing itself of the obstacles, so that their address is the vector sum of all the forces.</p>

<figure class="third ">
  
    
      <a href="/assets/images/exercises/obstacle_avoidance/obstacle_avoidance.png">
        <img src="/assets/images/exercises/obstacle_avoidance/obstacle_avoidance.png" alt="Obstacle Avoidance" />
      </a>
    
  
    
      <a href="/assets/images/exercises/obstacle_avoidance/obstacle_avoidance_teaser_gallery.png">
        <img src="/assets/images/exercises/obstacle_avoidance/obstacle_avoidance_teaser_gallery.png" alt="F1 laser" />
      </a>
    
  
    
      <a href="/assets/images/exercises/obstacle_avoidance/obstacle_avoidance_interface.png">
        <img src="/assets/images/exercises/obstacle_avoidance/obstacle_avoidance_interface.png" alt="Interface" />
      </a>
    
  
  
    <figcaption>Gallery
</figcaption>
  
</figure>

<p>The solution can integrate one or more of the following levels of difficulty, as well as any other one that occurs to you:</p>

<ul>
  <li>
    <p>Go as quickly as possible</p>
  </li>
  <li>
    <p>Choose the safest way</p>
  </li>
  <li>
    <p>Obstacles in movement</p>
  </li>
  <li>
    <p>Robustness in situations of indecision (zero vector sum)</p>
  </li>
</ul>

<h2 id="instructions-for-web-templates">Instructions for Web Templates</h2>
<p>This is the preferred way to run the exercise.</p>

<h3 id="installation">Installation</h3>

<ul>
  <li>
    <p>Clone the Robotics Academy repository on your local machine</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/JdeRobot/RoboticsAcademy
</code></pre></div>    </div>
  </li>
  <li>
    <p>Download <a href="https://docs.docker.com/get-docker/">Docker</a>. Windows users should choose WSL 2 backend Docker installation if possible, as it has better performance than Hyper-V.</p>
  </li>
  <li>
    <p>Pull the current distribution of Robotics Academy Docker Image</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull jderobot/robotics-academy:3.1.3
</code></pre></div>    </div>
  </li>
  <li>
    <p>In order to obtain optimal performance, Docker should be using multiple CPU cores. In case of Docker for Mac or Docker for Windows, the VM should be assigned a greater number of cores.</p>
  </li>
</ul>

<h3 id="enable-gpu-acceleration">Enable GPU Acceleration</h3>
<ul>
  <li>For Linux machines with NVIDIA GPUs, acceleration can be enabled by using NVIDIA proprietary drivers, installing  <a href="https://virtualgl.org/">VirtualGL</a> and executing the following docker run command:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="nt">--device</span> /dev/dri <span class="nt">-p</span> 8000:8000 <span class="nt">-p</span> 2303:2303 <span class="nt">-p</span> 1905:1905 <span class="nt">-p</span> 8765:8765 <span class="nt">-p</span> 6080:6080 <span class="nt">-p</span> 1108:1108 jderobot/robotics-academy:3.1.3 ./start-3.1.sh
</code></pre></div>    </div>
  </li>
  <li>For Windows machines, GPU acceleration to Docker is an experimental approach and can be implemented as per instructions given <a href="https://www.docker.com/blog/wsl-2-gpu-support-is-here/">here</a></li>
</ul>

<h3 id="how-to-perform-the-exercise">How to perform the exercise?</h3>
<ul>
  <li>
    <p>Start a new docker container of the image and keep it running in the background (<a href="#enable-gpu-acceleration">hardware accelerated version</a>)</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="nt">-p</span> 8000:8000 <span class="nt">-p</span> 2303:2303 <span class="nt">-p</span> 1905:1905 <span class="nt">-p</span> 8765:8765 <span class="nt">-p</span> 6080:6080 <span class="nt">-p</span> 1108:1108 jderobot/robotics-academy:3.1.3 ./start-3.1.sh
</code></pre></div>    </div>
  </li>
  <li>
    <p>On the local machine navigate to 127.0.0.1:8000/ in the browser and choose the desired exercise.</p>
  </li>
  <li>
    <p>Click the connect button and wait for some time until an alert appears with the message <code class="language-plaintext highlighter-rouge">Connection Established</code> and button displays connected.</p>
  </li>
  <li>
    <p>The exercise can be used after the alert.</p>
  </li>
</ul>

<p><strong>Where to insert the code?</strong></p>

<p>In the launched webpage, type your code in the text editor,</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">GUI</span> <span class="kn">import</span> <span class="n">GUI</span>
<span class="kn">from</span> <span class="nn">HAL</span> <span class="kn">import</span> <span class="n">HAL</span>
<span class="c1"># Enter sequential code!
</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># Enter iterative code!
</span>    <span class="n">currentTarget</span> <span class="o">=</span> <span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">getNextTarget</span><span class="p">()</span>
    <span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">targetx</span> <span class="o">=</span> <span class="n">currentTarget</span><span class="p">.</span><span class="n">getPose</span><span class="p">().</span><span class="n">x</span>
    <span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">targety</span> <span class="o">=</span> <span class="n">currentTarget</span><span class="p">.</span><span class="n">getPose</span><span class="p">().</span><span class="n">y</span>
</code></pre></div></div>

<h3 id="using-the-interface">Using the Interface</h3>

<ul>
  <li>
    <p><strong>Control Buttons</strong>: The control buttons enable the control of the interface. Play button sends the code written by User to the Robot. Stop button stops the code that is currently running on the Robot. Save button saves the code on the local machine. Load button loads the code from the local machine. Reset button resets the simulation(primarily, the position of the robot).</p>
  </li>
  <li>
    <p><strong>Frequency Slider</strong>: This slider adjusts the running frequency of the iterative part of the code(under the <code class="language-plaintext highlighter-rouge">while True:</code>). A smaller value implies the code runs less number of times. A higher value implies the code runs a large number of times. The Target Frequency is the one set on the Slider and Measured Frequency is the one measured by the computer(a frequency of execution the computer is able to maintain despite the commanded one). The student should adjust the Target Frequency according to the Measured Frequency.</p>
  </li>
  <li>
    <p><strong>Debug Level</strong>: This decides the debugging level of the code. A debug level of 1 implies no debugging at all. At this level, all the GUI functions written by the student are automatically removed when the student sends the code to the robot. A debug level greater than or equal to 2 enables all the GUI functions working properly.</p>
  </li>
  <li>
    <p><strong>Lap Time</strong>: The lap timer starts once the Robot car, has collected the first waypoint.</p>
  </li>
  <li>
    <p><strong>Psuedo Console</strong>: This shows the error messages related to the student’s code that is sent. In order to print certain debugging information on this console. The student is provided with <code class="language-plaintext highlighter-rouge">console.print()</code> similar to <code class="language-plaintext highlighter-rouge">print()</code> command in the Python Interpreter.</p>
  </li>
</ul>

<p><strong>Application Programming Interface</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">from HAL import HAL</code> - to import the HAL(Hardware Abstraction Layer) library class. This class contains the functions that sends and receives information to and from the Hardware(Gazebo).</li>
  <li><code class="language-plaintext highlighter-rouge">from GUI import GUI</code> - to import the GUI(Graphical User Interface) library class. This class contains the functions used to view the debugging information, like image widgets.</li>
  <li><code class="language-plaintext highlighter-rouge">HAL.getPose3d().x</code> - to get the position of the robot (x coordinate)</li>
  <li><code class="language-plaintext highlighter-rouge">HAL.getPose3d().y</code> - to obtain the position of the robot (y coordinate)</li>
  <li><code class="language-plaintext highlighter-rouge">HAL.getPose3d().yaw</code> - to get the orientation of the robot with
regarding the map</li>
  <li><code class="language-plaintext highlighter-rouge">HAL.getLaserData()</code> - to obtain laser sensor data
It is composed of 180 pairs of values: (0-180º distance in millimeters)</li>
  <li><code class="language-plaintext highlighter-rouge">HAL.getImage()</code> - to get the image</li>
  <li><code class="language-plaintext highlighter-rouge">HAL.motors.sendV()</code> - to set the linear speed</li>
  <li><code class="language-plaintext highlighter-rouge">HAL.motors.sendW()</code> - to set the angular velocity</li>
  <li><code class="language-plaintext highlighter-rouge">GUI.showImage()</code> - allows you to view a debug image or with relevant information</li>
</ul>

<p><strong>Own API</strong></p>

<p>To simplify, the implementation of control points is offered.
To use it, only two actions must be carried out:</p>
<ol>
  <li>
    <p>Obtain the following point:</p>

    <p><code class="language-plaintext highlighter-rouge">currentTarget = GUI.map.getNextTarget()</code></p>
  </li>
  <li>
    <p>Mark it as visited when necessary:</p>

    <p><code class="language-plaintext highlighter-rouge">currentTarget.setReached(True)</code></p>
  </li>
</ol>

<p><strong>Debugging</strong></p>

<p>The graphical interface (GUI) allows to visualize each of the vectors of
calculated forces. For this purpose, the following variables should be given 
value:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Car direction
</span><span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">carx</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">cary</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Obstacles direction
</span><span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">obsx</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">obsy</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Average direction
</span><span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">avgx</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">avgy</span> <span class="o">=</span> <span class="mf">0.0</span>
</code></pre></div></div>

<p>As well as the destination that we have assigned:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Current target
</span><span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">targetx</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">GUI</span><span class="p">.</span><span class="nb">map</span><span class="p">.</span><span class="n">targety</span> <span class="o">=</span> <span class="mf">0.0</span>
</code></pre></div></div>

<h2 id="instructions-for-rosnode-templates">Instructions for ROSNode Templates</h2>

<h3 id="installation-1">Installation</h3>
<p>Install the <a href="https://jderobot.github.io/RoboticsAcademy/installation/#generic-infrastructure">General Infrastructure</a> of the JdeRobot Robotics Academy.</p>

<h3 id="how-to-run-your-solution">How to run your solution?</h3>

<p>Navigate to the obstacle_avoidance directory</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>exercises/obstacle_avoidance
</code></pre></div></div>

<p>Launch Gazebo with the f1_simple_circuitobstacles world through the command</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>roslaunch ./launch/obstacle_avoidance_f1.launch
</code></pre></div></div>

<p>Then you have to execute the academic application, which will incorporate your code:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python ./obstacle_avoidance_f1.py obstacle_avoidance_conf_f1.yml
</code></pre></div></div>

<h3 id="how-to-do-the-practice">How to do the practice</h3>
<p>To carry out the practice, you must edit the file <code class="language-plaintext highlighter-rouge">MyAlgorithm.py</code> and
insert the control logic.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="bp">self</span><span class="p">.</span><span class="n">currentTarget</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">getNextTarget</span><span class="p">()</span>
  <span class="bp">self</span><span class="p">.</span><span class="n">targetx</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">currentTarget</span><span class="p">.</span><span class="n">getPose</span><span class="p">().</span><span class="n">x</span>
  <span class="bp">self</span><span class="p">.</span><span class="n">targety</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">currentTarget</span><span class="p">.</span><span class="n">getPose</span><span class="p">().</span><span class="n">y</span>

  <span class="c1"># TODO
</span>  <span class="c1"># insert your code here
</span></code></pre></div></div>

<p><strong>API</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pose3d.getPose3d().x</code> - to get the position of the robot (x coordinate)</li>
  <li><code class="language-plaintext highlighter-rouge">pose3d.getPose3d().y</code> - to obtain the position of the robot (y coordinate)</li>
  <li><code class="language-plaintext highlighter-rouge">pose3d.getPose3d().yaw</code> - to get the orientation of the robot with
regarding the map</li>
  <li><code class="language-plaintext highlighter-rouge">laser.getLaserData()</code> - to obtain laser sensor data
It is composed of 180 pairs of values: (0-180º distance in millimeters)</li>
  <li><code class="language-plaintext highlighter-rouge">motors.sendV()</code> - to set and send the linear speed</li>
  <li><code class="language-plaintext highlighter-rouge">motors.sendW()</code> - to set and send the angular velocity</li>
</ul>

<p><strong>Own API</strong></p>

<p>To simplify, the implementation of control points is offered.
To use it, only two actions must be carried out:</p>
<ol>
  <li>Obtain the following point:
<code class="language-plaintext highlighter-rouge">self.currentTarget = self.getNextTarget()</code></li>
  <li>Mark it as visited when necessary:
<code class="language-plaintext highlighter-rouge">self.currentTarget.setReached(True)</code></li>
</ol>

<h3 id="conversion-of-types">Conversion of types</h3>

<p><strong>Laser</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">laser_data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">laser</span><span class="p">.</span><span class="n">getLaserData</span> <span class="p">()</span>

<span class="k">def</span> <span class="nf">parse_laser_data</span> <span class="p">(</span><span class="n">laser_data</span><span class="p">):</span>
    <span class="n">laser</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">laser_data</span><span class="p">.</span><span class="n">numLaser</span><span class="p">):</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">laser_data</span><span class="p">.</span><span class="n">distanceData</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span><span class="mf">1000.0</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">radians</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">laser</span> <span class="o">+</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dist</span><span class="p">,</span> <span class="n">angle</span><span class="p">)]</span>
      <span class="k">return</span> <span class="n">laser</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">laser_vectorized</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">laser</span><span class="p">:</span>
    <span class="c1"># (4.2.1) laser into GUI reference system
</span>    <span class="n">x</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">cos</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">sin</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">laser_vectorized</span> <span class="o">+</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>

<span class="n">laser_mean</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span> <span class="p">(</span><span class="n">laser_vectorized</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Coordinate system</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">absolute2relative</span> <span class="p">(</span><span class="n">x_abs</span><span class="p">,</span> <span class="n">y_abs</span><span class="p">,</span> <span class="n">robotx</span><span class="p">,</span> <span class="n">roboty</span><span class="p">,</span> <span class="n">robott</span><span class="p">):</span>

    <span class="c1"># robotx, roboty are the absolute coordinates of the robot
# robott is its absolute orientation
</span>    <span class="c1"># Convert to relatives
</span>    <span class="n">dx</span> <span class="o">=</span> <span class="n">x_abs</span> <span class="o">-</span> <span class="n">robotx</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">y_abs</span> <span class="o">-</span> <span class="n">roboty</span>

    <span class="c1"># Rotate with current angle
</span>    <span class="n">x_rel</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">cos</span> <span class="p">(</span><span class="o">-</span><span class="n">robott</span><span class="p">)</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">sin</span> <span class="p">(</span><span class="o">-</span><span class="n">robott</span><span class="p">)</span>
    <span class="n">y_rel</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">sin</span> <span class="p">(</span><span class="o">-</span><span class="n">robott</span><span class="p">)</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">cos</span> <span class="p">(</span><span class="o">-</span><span class="n">robott</span><span class="p">)</span>

<span class="k">return</span> <span class="n">x_rel</span><span class="p">,</span> <span class="ow">and</span> <span class="n">y_rel</span>
</code></pre></div></div>

<h3 id="debugging">Debugging</h3>
<p>The graphical interface (GUI) allows to visualize each of the vectors of
calculated forces. For this purpose, the following variables should be given 
value:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Car direction
</span><span class="bp">self</span><span class="p">.</span><span class="n">carx</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="bp">self</span><span class="p">.</span><span class="n">cary</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Obstacles direction
</span><span class="bp">self</span><span class="p">.</span><span class="n">obsx</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="bp">self</span><span class="p">.</span><span class="n">obsy</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Average direction
</span><span class="bp">self</span><span class="p">.</span><span class="n">avgx</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="bp">self</span><span class="p">.</span><span class="n">avgy</span> <span class="o">=</span> <span class="mf">0.0</span>
</code></pre></div></div>

<p>As well as the destination that we have assigned:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Current target
</span><span class="bp">self</span><span class="p">.</span><span class="n">targetx</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="bp">self</span><span class="p">.</span><span class="n">targety</span> <span class="o">=</span> <span class="mf">0.0</span>
</code></pre></div></div>

<h2 id="theory">Theory</h2>
<p>This exercise requires us to implement a local navigation algorithm called Virtual Force Field Algorithm. Following is the complete theory regarding this algorithm.</p>

<h3 id="navigation">Navigation</h3>
<p>Robot Navigation involves all the related tasks and algorithms required to take a robot from point A to point B <strong>autonomously</strong> without making any collisions. It is a very well studied topic in Mobile Robotics, comprising volumes of books! The problem of Navigation is broken down into the following subproblems:</p>

<ul>
  <li><strong>Localisation</strong>: The robot needs to know where it is.</li>
  <li><strong>Collision Avoidance</strong>: The robot needs to detect and avoid obstacles</li>
  <li><strong>Mapping</strong>: The robot needs to remember its surroundings</li>
  <li><strong>Planning</strong>: The robot needs to be able to plan a route to point B</li>
  <li><strong>Explore</strong>: The robot needs to be able to explore new terrain</li>
</ul>

<p><img src="http://localhost:4000/RoboticsAcademy/assets/images/exercises/obstacle_avoidance/robot-navigation-problems.png" alt="Robot Navigation Problems" /></p>

<p>Some of the ways to achieve the task of Navigation are as follows:</p>

<ul>
  <li><strong>Vision Based</strong>: Computer Vision algorithms and optical sensors, like LIDAR sensors are used for Vision Based Navigation.</li>
  <li><strong>Inertial Navigation</strong>: Airborne robots use <a href="https://en.wikipedia.org/wiki/Inertial_measurement_unit">inertial sensors</a> for Navigation</li>
  <li><strong>Acoustic Navigation</strong>: Underwater robots use SONAR based Navigation Systems</li>
  <li><strong>Radio Navigation</strong>: Navigation used RADAR technology.</li>
</ul>

<p>The problem of Path Planning in Navigation is dealt in 2 ways, which are Global Navigation and Local Navigation</p>

<h3 id="global-navigation">Global Navigation</h3>
<p>Global Navigation involves the use of a map of the environment to plan a path from point A to point B. The optimality of the path is decided based on the length of the path, the time taken to reach the target, using permanent roads etc. Global Positioning System(GPS) is one such example of Global Navigation. The algorithms used behind such systems may include <a href="https://www.youtube.com/watch?v=GazC3A4OQTE">Dijkstra</a>, Best First or <a href="https://www.youtube.com/watch?v=ySN5Wnu88nE">A*</a> etc.</p>

<h3 id="local-navigation">Local Navigation</h3>
<p>Once the global path is decided, it is broken down into suitable waypoints. The robot navigates through these waypoints in order to reach it’s destination. Local Navigation involves a dynamically changing path plan taking into consideration the changing surroundings and the vehicle constraints. Some examples of such algorithms would be Virtual Force Field, <a href="https://link.springer.com/chapter/10.1007/978-3-319-62533-1_7">Follow Wall</a>, <a href="https://link.springer.com/chapter/10.1007/978-3-319-62533-1_7">Pledge Algorithm</a> etc.</p>

<h3 id="virtual-force-field-algorithm">Virtual Force Field Algorithm</h3>
<p>The Virtual Force Field Algorithm works in the following steps:</p>

<ul>
  <li>The robot assigns an attractive vector to the waypoint that points towards the waypoint.</li>
  <li>The robot assigns a repulsive vector to the obstacle according to its sensor readings that points away from the waypoint. This is done by summing all the vectors that are translated from the sensor readings.</li>
  <li>The robot follows the vector obtained by summing the target and obstacle vector.</li>
</ul>

<p><img src="http://localhost:4000/RoboticsAcademy/assets/images/exercises/obstacle_avoidance/vff.png" alt="VFF" /></p>

<h3 id="drawbacks">Drawbacks</h3>
<p>There are a few problems related to this algorithm:</p>

<ul>
  <li>The robot tends to oscillate in narrow corridors, that is when the robot receives an obstacle vector simultaneously from opposite sides.</li>
  <li>The robot may not be able to enter narrow corridors in the first place!</li>
</ul>

<p><img src="http://localhost:4000/RoboticsAcademy/assets/images/exercises/obstacle_avoidance/drawbacks.png" alt="Drawbacks" /></p>

<h3 id="virtual-force-histogram-algorithm">Virtual Force Histogram Algorithm</h3>
<p>This algorithm improves over the Virtual Force Field Algorithm, by using a data structure called the Polar Histogram. The robot maintains a histogram grid of the  instantaneous sensor values received. Then, based on the threshold value set by the programmer, the program detects minimas(valleys) in the polar histogram. The angle corresponding to these values are then followed by the robot.</p>

<p><img src="http://localhost:4000/RoboticsAcademy/assets/images/exercises/obstacle_avoidance/vfh.gif" alt="VFH" /></p>

<p><strong>Note</strong>: The exercise only requires us to implement Virtual Force Field Algorithm</p>

<h2 id="hints">Hints</h2>
<p>Simple hints provided to help you solve the local_navigation exercise. Please note that the <strong>full solution has not been provided.</strong></p>

<h3 id="determining-the-vectors">Determining the Vectors</h3>
<p>First of all, we need to generate the 3 required vectors, that are the <strong>Target Vector</strong>, <strong>Obstacle Vector</strong> and the <strong>Direction Vector</strong>.</p>

<h3 id="target-vector">Target Vector</h3>
<p>The target vector can be easily obtained by subtracting the position of the car from the position of the next waypoint.</p>

<p>In order to implement this on the GUI interface of the exercise, in addition to the vector obtained by subtracting, we need to apply a rotation to the vector as well. The purpose of rotation is to keep the target vector always in the direction of the waypoint and not in front of the car. You may try seeing this in your own implementation, or refer to the <a href="#Illustrations">illustrations</a></p>

<p>Refer to this <a href="https://en.wikipedia.org/wiki/Rotation_matrix#In_two_dimensions">webpage</a> to know about the exact mathematical details of the implementation.</p>

<h3 id="obstacle-vector">Obstacle Vector</h3>
<p>The obstacle vector is to be calculated from the sensor readings we obtain from the surroundings of the robot. Each obstacle in front of the car, is going to provide a repulsive vector, which we will add to obtain the resultant repulsive vector. Assign a repulsive vector, for each of the 180 sensor readings. The magnitude of the repulsive vector is inversely proportional to the magnitude of the sensor reading. Once, all the repulsive vectors are obtained they are all added, to get the resultant.</p>

<p><strong>Note</strong>: There is a catch in this case, you may notice that most of the time in our implementation of the exercise we get an obstacle vector which is almost always pointing opposite to the direction in which we are supposed to head. This is a problem, as adding this vector directly to the target vector, would give a resultant which is more or less, quite not we expect. Hence, there is some trick we need to apply to solve this problem.</p>

<p><img src="http://localhost:4000/RoboticsAcademy/assets/images/exercises/obstacle_avoidance/obstacle_vector.png" alt="Obstacle Vector" />
<em>Obstacle Vector without any obstacles in front of the car</em></p>

<h3 id="direction-vector">Direction Vector</h3>
<p>Conventionally and according to the research paper of the VFF algorithm, in order to obtain the direction vector we should add the target vector and the obstacle vector. But, due to an inherent problem behind the calculation of the obstacle vector, we cannot simply add them to obtain the resultant.</p>

<p>A simple observation reveals that we are required to <strong>keep moving forward</strong> for the purpose of this exercise. Hence, the component of the direction vector in the direction of motion of the car, has no effect on the motion of the car. Therefore, we can simply leave it as a <strong>constant</strong>, while adjusting the vector responsible for the steering of the car. It is the steering, that will in fact, provide us with the obstacle avoidance capabilities. Hence, the steering is going to be controlled by the Direction Vector.</p>

<p>Also, please note that this is <strong>not the only solution</strong> to this problem. We may also add an offset vector in the direction of motion of the car to cancel the effect of the redundant component.</p>

<h3 id="illustrations">Illustrations</h3>

<figure class="half ">
  
    
      <a href="/assets/images/exercises/obstacle_avoidance/with_rotation.gif" title="On applying the rotation matrix">
        <img src="/assets/images/exercises/obstacle_avoidance/with_rotation.gif" alt="examples" />
      </a>
    
  
    
      <a href="/assets/images/exercises/obstacle_avoidance/without_rotation.gif" title="Without applying the rotation matrix">
        <img src="/assets/images/exercises/obstacle_avoidance/without_rotation.gif" alt="examples" />
      </a>
    
  
  
    <figcaption>On applying the rotation matrix (left) - Without applying the rotation matrix (right)
</figcaption>
  
</figure>

<figure class=" ">
  
    
      <a href="/assets/images/exercises/obstacle_avoidance/oscillations.gif" title="Oscillation Problem in Narrow Corridors">
        <img src="/assets/images/exercises/obstacle_avoidance/oscillations.gif" alt="examples" />
      </a>
    
  
  
    <figcaption>Oscillation Problem in Narrow Corridors
</figcaption>
  
</figure>

<h2 id="demonstrative-video">Demonstrative Video</h2>

<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/5SVkvfKPi_s" width="700" height="480" frameborder="0" allowfullscreen="">
  </iframe>
</div>

<p><em>This solution is an illustration for the ROSNode Templates</em></p>

<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/wVJJ9ndY2aY" width="700" height="480" frameborder="0" allowfullscreen="">
  </iframe>
</div>

<p><em>This solution is an illustration for the Web Templates</em></p>

<h2 id="contributors">Contributors</h2>

<ul>
  <li>Contributors: <a href="https://github.com/almartinflorido">Alberto Martín</a>, <a href="eperdices@gsyc.es">Eduardo Perdices</a>, <a href="https://github.com/fqez">Francisco Pérez</a>, Victor Arribas, <a href="julio.vega@urjc.es">Julio Vega</a>, <a href="https://gsyc.urjc.es/jmplaza/">Jose María Cañas</a>, <a href="https://github.com/igarag">Nacho Arranz</a>.</li>
  <li>Maintained by <a href="https://github.com/SakshayMahna">Sakshay Mahna</a>.</li>
</ul>

<h2 id="references">References</h2>
<p><a href="http://www-personal.umich.edu/~johannb/vff&amp;vfh.htm">1</a>
<a href="https://en.wikibooks.org/wiki/Robotics/Navigation">2</a>
<a href="https://en.wikipedia.org/wiki/Robot_navigation">3</a>
<a href="https://www.hindawi.com/journals/jat/2018/6392697/">4</a>
<a href="https://link.springer.com/chapter/10.1007/978-3-319-62533-1_7">5</a>
<a href="https://www.researchgate.net/figure/The-virtual-force-field-VFF-concept-Occupied-cells-exert-repulsive-forces-onto-the_fig1_224749557">6</a>
<a href="http://www.cs.cmu.edu/~./motionplanning/papers/sbp_papers/integrated1/borenstein_cluttered_obstacle_avoid.pdf">7</a>
<a href="https://www.mathsisfun.com/algebra/vectors.html">8</a>
<a href="https://matthew-brett.github.io/teaching/rotation_2d.html">9</a></p>


        
      </section>

      <footer class="page__meta">
        
        


        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/jderobot" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/JdeRobot/RoboticsAcademy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
          <li><a href="https://www.youtube.com/channel/UCgmUgpircYAv_QhLQziHJOQ" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i> Youtube</a></li>
        
      
    

   <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 JdeRobot. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>


      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
  </script>
  <script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       extensions: ["tex2jax.js"],
       jax: ["input/TeX", "output/HTML-CSS"],
       tex2jax: {
         inlineMath: [ ['$','$'], ["\\(","\\)"] ],
         displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
         processEscapes: true
       },
       "HTML-CSS": { availableFonts: ["TeX"] }
     });
  </script>










  </body>
</html>
